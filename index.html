<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenIKEv2 Integration Layer Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .dashboard-card {
            transition: transform 0.2s;
        }
        .dashboard-card:hover {
            transform: translateY(-2px);
        }
        .session-card {
            border-left: 4px solid #6c757d;
            margin-bottom: 10px;
        }
        .session-card.established {
            border-left-color: #198754;
        }
        .session-card.connecting {
            border-left-color: #ffc107;
        }
        .session-card.failed {
            border-left-color: #dc3545;
        }
        .session-card.disconnected {
            border-left-color: #6c757d;
        }
        .status-badge {
            font-size: 0.8em;
        }
        .real-time-indicator {
            width: 10px;
            height: 10px;
            background-color: #198754;
            border-radius: 50%;
            display: inline-block;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.7; }
            100% { transform: scale(1); opacity: 1; }
        }
        .logs-container {
            background-color: #212529;
            color: #fff;
            font-family: 'Courier New', monospace;
            max-height: 300px;
            overflow-y: auto;
        }
        .chart-container {
            height: 300px;
        }
    </style>
</head>
<body class="bg-light">
    <nav class="navbar navbar-dark bg-dark">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1">
                <i class="fas fa-shield-alt"></i> OpenIKEv2 Integration Layer
            </span>
            <span class="navbar-text">
                <span class="real-time-indicator"></span> Live Monitoring
            </span>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <!-- System Status Row -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card dashboard-card h-100">
                    <div class="card-body text-center">
                        <i class="fas fa-server fa-3x text-primary mb-2"></i>
                        <h5 class="card-title">System Status</h5>
                        <p class="card-text" id="system-uptime">--</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card dashboard-card h-100">
                    <div class="card-body text-center">
                        <i class="fas fa-link fa-3x text-success mb-2"></i>
                        <h5 class="card-title">Active Sessions</h5>
                        <h2 class="card-text text-success" id="active-sessions">0</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card dashboard-card h-100">
                    <div class="card-body text-center">
                        <i class="fas fa-history fa-3x text-info mb-2"></i>
                        <h5 class="card-title">Total Sessions</h5>
                        <h2 class="card-text text-info" id="total-sessions">0</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card dashboard-card h-100">
                    <div class="card-body text-center">
                        <i class="fas fa-exchange-alt fa-3x text-warning mb-2"></i>
                        <h5 class="card-title">Data Transfer</h5>
                        <p class="card-text">
                            <small>↑ <span id="bytes-sent">0</span> B</small><br>
                            <small>↓ <span id="bytes-received">0</span> B</small>
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Session Management Row -->
        <div class="row mb-4">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5><i class="fas fa-network-wired"></i> Active Sessions</h5>
                        <button class="btn btn-primary btn-sm" onclick="createSession()">
                            <i class="fas fa-plus"></i> Create Session
                        </button>
                    </div>
                    <div class="card-body" id="sessions-container">
                        <div class="text-center text-muted">
                            <i class="fas fa-spinner fa-spin"></i> Loading sessions...
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-chart-line"></i> Connection States</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="statesChart" class="chart-container"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Monitoring & Logs Row -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-chart-area"></i> Traffic Monitor</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="trafficChart" class="chart-container"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5><i class="fas fa-terminal"></i> System Logs</h5>
                        <button class="btn btn-sm btn-outline-secondary" onclick="clearLogs()">
                            <i class="fas fa-trash"></i> Clear
                        </button>
                    </div>
                    <div class="card-body p-0">
                        <div class="logs-container p-3" id="system-logs">
                            <div>System initialized...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Configuration & API Info -->
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-cog"></i> Configuration</h5>
                    </div>
                    <div class="card-body">
                        <pre id="config-display" class="bg-light p-3 rounded" style="font-size: 0.8em;"></pre>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-code"></i> API Endpoints</h5>
                    </div>
                    <div class="card-body">
                        <div class="list-group list-group-flush">
                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                <code>GET /api/status</code>
                                <span class="badge bg-success rounded-pill">GET</span>
                            </div>
                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                <code>GET /api/sessions</code>
                                <span class="badge bg-success rounded-pill">GET</span>
                            </div>
                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                <code>POST /api/sessions</code>
                                <span class="badge bg-primary rounded-pill">POST</span>
                            </div>
                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                <code>POST /api/sessions/{id}/start</code>
                                <span class="badge bg-primary rounded-pill">POST</span>
                            </div>
                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                <code>POST /api/sessions/{id}/stop</code>
                                <span class="badge bg-primary rounded-pill">POST</span>
                            </div>
                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                <code>DELETE /api/sessions/{id}</code>
                                <span class="badge bg-danger rounded-pill">DELETE</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3" id="toast-container"></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Global variables
        let statesChart, trafficChart;
        let trafficData = [];
        let maxTrafficPoints = 20;

        // Initialize charts
        function initCharts() {
            // States Chart (Doughnut)
            const statesCtx = document.getElementById('statesChart').getContext('2d');
            statesChart = new Chart(statesCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Established', 'Connecting', 'Failed', 'Disconnected'],
                    datasets: [{
                        data: [0, 0, 0, 0],
                        backgroundColor: ['#198754', '#ffc107', '#dc3545', '#6c757d'],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });

            // Traffic Chart (Line)
            const trafficCtx = document.getElementById('trafficChart').getContext('2d');
            trafficChart = new Chart(trafficCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Bytes Sent',
                        data: [],
                        borderColor: '#0d6efd',
                        backgroundColor: 'rgba(13, 110, 253, 0.1)',
                        tension: 0.4
                    }, {
                        label: 'Bytes Received',
                        data: [],
                        borderColor: '#198754',
                        backgroundColor: 'rgba(25, 135, 84, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top'
                        }
                    }
                }
            });
        }

        // Update system status
        function updateSystemStatus(data) {
            document.getElementById('system-uptime').textContent = data.system.uptime || '--';
            document.getElementById('active-sessions').textContent = data.statistics.active_sessions || 0;
            document.getElementById('total-sessions').textContent = data.statistics.total_sessions || 0;
            document.getElementById('bytes-sent').textContent = formatBytes(data.statistics.traffic.total_bytes_sent || 0);
            document.getElementById('bytes-received').textContent = formatBytes(data.statistics.traffic.total_bytes_received || 0);

            // Update states chart
            if (statesChart) {
                const states = data.statistics.states || {};
                statesChart.data.datasets[0].data = [
                    states.established || 0,
                    (states.connecting || 0) + (states.authenticating || 0) + (states.establishing || 0),
                    states.failed || 0,
                    states.disconnected || 0
                ];
                statesChart.update();
            }

            // Update traffic chart
            if (trafficChart) {
                const now = new Date().toLocaleTimeString();
                trafficData.push({
                    time: now,
                    sent: data.statistics.traffic.total_bytes_sent || 0,
                    received: data.statistics.traffic.total_bytes_received || 0
                });

                if (trafficData.length > maxTrafficPoints) {
                    trafficData.shift();
                }

                trafficChart.data.labels = trafficData.map(d => d.time);
                trafficChart.data.datasets[0].data = trafficData.map(d => d.sent);
                trafficChart.data.datasets[1].data = trafficData.map(d => d.received);
                trafficChart.update();
            }
        }

        // Update sessions display
        function updateSessions(sessions) {
            const container = document.getElementById('sessions-container');
            
            if (!sessions || sessions.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-muted">
                        <i class="fas fa-info-circle"></i> No active sessions
                    </div>
                `;
                return;
            }

            let html = '';
            sessions.forEach(session => {
                const stateClass = session.state.toLowerCase();
                const stateIcon = getStateIcon(session.state);
                
                html += `
                    <div class="session-card card ${stateClass} mb-2">
                        <div class="card-body py-2">
                            <div class="row align-items-center">
                                <div class="col-md-3">
                                    <strong>${session.session_id}</strong>
                                    <br><small class="text-muted">${session.remote_addr}:${session.remote_port}</small>
                                </div>
                                <div class="col-md-2">
                                    <span class="badge bg-${getStateBadgeColor(session.state)} status-badge">
                                        ${stateIcon} ${session.state}
                                    </span>
                                </div>
                                <div class="col-md-2">
                                    <small>Uptime: ${session.uptime || '--'}</small>
                                </div>
                                <div class="col-md-2">
                                    <small>
                                        ↑${formatBytes(session.statistics.bytes_sent)}<br>
                                        ↓${formatBytes(session.statistics.bytes_received)}
                                    </small>
                                </div>
                                <div class="col-md-3 text-end">
                                    <div class="btn-group btn-group-sm">
                                        <button class="btn btn-outline-success" onclick="startSession('${session.session_id}')" 
                                                ${session.state === 'ESTABLISHED' ? 'disabled' : ''}>
                                            <i class="fas fa-play"></i>
                                        </button>
                                        <button class="btn btn-outline-warning" onclick="stopSession('${session.session_id}')"
                                                ${session.state === 'DISCONNECTED' ? 'disabled' : ''}>
                                            <i class="fas fa-stop"></i>
                                        </button>
                                        <button class="btn btn-outline-danger" onclick="deleteSession('${session.session_id}')">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            ${session.error_message ? `<div class="mt-2"><small class="text-danger"><i class="fas fa-exclamation-triangle"></i> ${session.error_message}</small></div>` : ''}
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // Utility functions
        function getStateIcon(state) {
            const icons = {
                'IDLE': 'fas fa-pause',
                'CONNECTING': 'fas fa-spinner fa-spin',
                'AUTHENTICATING': 'fas fa-key',
                'ESTABLISHING': 'fas fa-handshake',
                'ESTABLISHED': 'fas fa-check-circle',
                'REKEYING': 'fas fa-sync fa-spin',
                'DELETING': 'fas fa-times',
                'FAILED': 'fas fa-exclamation-triangle',
                'DISCONNECTED': 'fas fa-unlink'
            };
            return `<i class="${icons[state] || 'fas fa-question'}"></i>`;
        }

        function getStateBadgeColor(state) {
            const colors = {
                'IDLE': 'secondary',
                'CONNECTING': 'warning',
                'AUTHENTICATING': 'info',
                'ESTABLISHING': 'info',
                'ESTABLISHED': 'success',
                'REKEYING': 'warning',
                'DELETING': 'warning',
                'FAILED': 'danger',
                'DISCONNECTED': 'secondary'
            };
            return colors[state] || 'secondary';
        }

        function formatBytes(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        }

        function showToast(message, type = 'info') {
            const toastHtml = `
                <div class="toast" role="alert" data-bs-autohide="true" data-bs-delay="3000">
                    <div class="toast-header">
                        <i class="fas fa-${type === 'success' ? 'check' : type === 'error' ? 'exclamation-triangle' : 'info'} me-2"></i>
                        <strong class="me-auto">Notification</strong>
                        <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
                    </div>
                    <div class="toast-body">${message}</div>
                </div>
            `;
            
            const container = document.getElementById('toast-container');
            container.insertAdjacentHTML('beforeend', toastHtml);
            
            const toast = new bootstrap.Toast(container.lastElementChild);
            toast.show();
        }

        function addLog(message) {
            const logsContainer = document.getElementById('system-logs');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.innerHTML = `<span style="color: #6c757d;">[${timestamp}]</span> ${message}`;
            logsContainer.appendChild(logEntry);
            logsContainer.scrollTop = logsContainer.scrollHeight;
        }

        function clearLogs() {
            document.getElementById('system-logs').innerHTML = '<div>Logs cleared...</div>';
        }

        // API functions
        function updateStatus() {
            fetch('/api/status')
                .then(response => response.json())
                .then(data => {
                    updateSystemStatus(data);
                    updateSessions(data.sessions);
                    
                    // Update configuration display
                    const configDisplay = document.getElementById('config-display');
                    configDisplay.textContent = JSON.stringify({
                        server: data.server || {},
                        monitoring: { update_interval: 1000, max_history: 100 }
                    }, null, 2);
                })
                .catch(error => {
                    console.error('Error fetching status:', error);
                    addLog('Error fetching system status');
                });
        }

        function createSession() {
            fetch('/api/sessions', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    showToast(`Session ${data.session_id} created successfully`, 'success');
                    addLog(`Created session: ${data.session_id}`);
                    updateStatus();
                })
                .catch(error => {
                    showToast('Failed to create session', 'error');
                    addLog('Failed to create session');
                });
        }

        function startSession(sessionId) {
            fetch(`/api/sessions/${sessionId}/start`, { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    showToast(`Session ${sessionId} started`, 'success');
                    addLog(`Started session: ${sessionId}`);
                    updateStatus();
                })
                .catch(error => {
                    showToast('Failed to start session', 'error');
                    addLog(`Failed to start session: ${sessionId}`);
                });
        }

        function stopSession(sessionId) {
            fetch(`/api/sessions/${sessionId}/stop`, { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    showToast(`Session ${sessionId} stopped`, 'success');
                    addLog(`Stopped session: ${sessionId}`);
                    updateStatus();
                })
                .catch(error => {
                    showToast('Failed to stop session', 'error');
                    addLog(`Failed to stop session: ${sessionId}`);
                });
        }

        function deleteSession(sessionId) {
            if (confirm(`Are you sure you want to delete session ${sessionId}?`)) {
                fetch(`/api/sessions/${sessionId}`, { method: 'DELETE' })
                    .then(response => response.json())
                    .then(data => {
                        showToast(`Session ${sessionId} deleted`, 'success');
                        addLog(`Deleted session: ${sessionId}`);
                        updateStatus();
                    })
                    .catch(error => {
                        showToast('Failed to delete session', 'error');
                        addLog(`Failed to delete session: ${sessionId}`);
                    });
            }
        }

        // Initialize application
        document.addEventListener('DOMContentLoaded', function() {
            initCharts();
            updateStatus();
            
            // Update status every 2 seconds
            setInterval(updateStatus, 2000);
            
            addLog('Dashboard initialized');
            addLog('Real-time monitoring started');
        });
    </script>
</body>
</html>
